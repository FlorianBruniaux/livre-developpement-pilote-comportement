<!doctype html>
<html lang="fr">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="author" content="Jean-François Lépine" />
    <meta name="date" content="23/02/2013"/>
    <meta name="generator" content="easybook 5.0-DEV"/>

    <title>Automatisez votre recette | Développeurs, faites-vous plaisir !</title>

    <link rel="stylesheet" href="./css/easybook.css" />

</head>

<body class="item chapter">
<div class="container">
<div class="menu">
    <div class="row">
        <h1 class="span9"><a href="./index.html">Développeurs, faites-vous plaisir !</a></h1>
        <p class="span3">
                        <a href="./chapitre-3.html"><span>&larr;</span> Précédent</a>
            
                        <a href="./chapitre-5.html">Suivant <span>&rarr;</span></a>
                    </p>
    </div>
</div>

<div class="row">
    <div class="span9">
        <h1 id="chapitre-4"><span>Chapitre 4</span> Automatisez votre recette</h1>
        <p>Vous l'avez vu, Gherkin est un moyen simple pour votre fonctionnel pour vous fournir
une expression de besoin claire et précise.</p>

<p>Que diriez-vous maintenant de traduire ce besoin en tests automatisés ? Car, oui, c'est possible !</p>

<p>Tout besoin, s'il est exprimé clairement, peut être testé. Si ce besoin est exprimé dans une
grammaire solide et complète, tout système d'information peut le tester automatiquement.</p>

<p>Je vous propose de voir comment traduire ce besoin en tests automatisés, de telle sorte
qu'une simple ligne de commande dans un terminal vous indique si ce que vous avez développé est 
conforme ou non.</p>

<p>L'ensemble des exemples que nous allons voir sont écrits en PHP. Pourquoi ? Tout simplement 
parce que la communauté PHP a très fortement et très rapidement adheré au Déve-
loppement piloté par le comportement. Les outils PHP pour le Développement piloté par
le comportement sont matures, nombreux, et surtout offrent une souplesse qui, à ce jour,
ne se retrouve pas dans d'autres langages.</p>

<p>Cependant, il existe des outils pour écrire et lancer des tests automatisés dans n'importe
quel langage :</p>

<ul>
<li>Ruby : Cucumber (http://cukes.info)</li>
<li>Java : JBehave (http://jbehave.org)</li>
<li>C# : NBehave (https://github.com/nbehave/NBehave)</li>
<li>Python : Behave (http://packages.python.org/behave/)</li>
<li>PHP : Behat (http://behat.org) , PHPSpec (http://www.phpspec.net)</li>
<li>JavaScript : Jasmine (http://pivotal.github.com/jasmine/)</li>
<li>.Net: NBehave (http://nbehave.org)</li>
</ul>

<p>Il en existe bien d'autres, la liste est loin d'être exhaustive, mais ceux-ci sont particulièrement 
utilisés dans le monde du développement aujourd'hui.</p>

<h2 id="installez-et-utilisez-behat-en-php">4.1 Installez et utilisez Behat en PHP</h2>

<p>Behat est un outil développé en PHP par Konstantin Kudryashov (@everzet) et soutenu
par la société KnpLabs. Cet outil efficace est aujourd'hui mature et largement utilisé.
Behat permet d'exécuter des tests automatisés sur tous types d'applications, PHP ou non.
Il peut tester :</p>

<ul>
<li>des applications web, en pilotant un vrai navigateur ou non</li>
<li>des applications console (terminal)</li>
<li>des morceaux de code source</li>
</ul>

<p>Du moment que ce qui est testé dispose d'un point d'entrée et d'une information de sortie,
Behat va vous permettre d'automatiser votre recette métier.</p>

<p>Dans tous les cas, il vous faudra PHP installé sur la machine qui exécutera les tests.
L'installation de PHP est résumée sur cette page : http://php.net/manual/fr/install.php.</p>

<p>Windows :</p>

<div class="code code bash">
<pre class="codebash">Utilisez WampServer (http://www.wampserver.com)</pre>
</div>

<p>Ubuntu, Debian :</p>

<div class="code code bash">
<pre class="codebash"># en ligne de commande
apt-get install php5-common php5-cli php5-curl</pre>
</div>

<p>Mac :</p>

<div class="code code bash">
<pre class="codebash">Utilisez MampServer (http://www.mamp.info)</pre>
</div>

<p>Installer Behat est simple, peut être fait de plusieurs manières : sous forme d'archive PHP
(phar) ou en utilisant un gestionnaire de dépendance.</p>

<h3 id="installation-avec-composer">4.1.1 Installation avec Composer</h3>

<p>Créez un fichier composer.json à la racine de votre projet, avec le contenu suivant :</p>

<div class="code json">
<pre class="json">{
    &quot;require&quot;: {
        &quot;behat/behat&quot;: &quot;2.4.*@stable&quot;
    },
    &quot;config&quot;: {
        &quot;bin-dir&quot;: &quot;bin/&quot;
    }
}</pre>
</div>

<p>Exécutez ensuite la commande suivante dans votre terminal, en vous plaçant àa la racine
de votre projet :</p>

<div class="code code bash">
<pre class="codebash">curl http://getcomposer.org/installer | php
php composer.phar install --prefer-source</pre>
</div>

<h3 id="-installation-sous-forme-darchive-phar">4.1.2  Installation sous forme d'archive Phar</h3>

<p>Il vous suffit de télécharger le fichier behat.phar à l'adresse suivante : http://behat.org/
downloads/behat.phar, et de le placer dans un dossier <code>bin</code> à la racine de votre projet. Vous
aurez donc l'arborescence suivante :</p>

<div class="code code bash">
<pre class="codebash">/chemin/vers/mon/projet
    (...)
    - bin/
        - behat.phar</pre>
</div>

<p>Pour des raisons de maintenabilité, il est préferable d'utiliser la méthode d'installation
avec Composer, qui vous permettra de mettre à jour très facilement l'ensemble des librairies 
PHP que vous utilisez, y compris Behat.</p>

<h3 id="preparer-le-projet">4.1.3 Préparer le projet</h3>

<p>Une fois que Behat est installé, il vous suffit d'exécuter la commande suivante :</p>

<div class="code code bash">
<pre class="codebash">php ./bin/behat --init</pre>
</div>

<p>Cela aura pour effet de créer dans votre projet tous les éléments dont Behat a besoin pour
fonctionner. Votre arboresence ressemble désormais à :</p>

<p>Vous voici désormais avec les dossiers suivants :</p>

<ul>
<li><code>features</code> : contient la listes des fonctionnalités, sous forme de fichier <code>.feature</code></li>
<li><code>features/bootstrap</code> : contient les fichiers PHP de traduction de Fonctionnalité en code source</li>
</ul>

<p>Chaque nouvelle fonctionnalité devra donc être ajoutée dans le dossier ̀ features<code>, sous forme d'un 
fichier</code>.feature<code>. Créez par exemple le fichier</code>features/calculer-mon-age.feature`, avec le 
contenu suivant :</p>

<div class="figure center" id="figure-4-1">
    <img src="images/dev-qr-exo1-step1.png" alt="Les sources de cet exercice sont disponibles sur http://goo.gl/4usXU" />

    <p class="caption"><strong>Figure 4.1</strong> Les sources de cet exercice sont disponibles sur http://goo.gl/4usXU</p>
</div>


<div class="code code gherkin">
<pre class="codegherkin"># language: fr
Fonctionnalité: Calculer l'âge d'une personne
    En tant qu'utilisateur de l'application
    Je veux connaître le nombre d'années écoulées entre deux dates
    De telle sorte que je puisse connaître mon age</pre>
</div>

<div class="code code">
<pre class="code">Scénario: Calculer l'âge d'une personne depuis une date antérieure à aujourd'hui
    Etant donné que je suis né le 06/07/1986
    Et que nous sommes le 20/09/013
    Quand je calcule mon âge
    Alors je suis informé que j'ai 27 ans</pre>
</div>

<div class="code code">
<pre class="code">Scénario: Calculer l'âge d'une personne depuis une date postérieure à aujourd'hui
    Etant donné que je suis né le 06/07/3013
    Et que nous sommes le 20/09/2013
    Quand je calcule mon âge
    Alors je suis informé que je ne suis pas encore né</pre>
</div>

<div class="code code">
<pre class="code">Scénario: Calculer l'âge d'une personne dont c'est l'anniversaire aujourd'hui
    Etant donné que je suis né le 06/07/1986
    Et que nous sommes le 06/07/2013
    Quand je calcule mon âge
    Alors je suis informé que j'ai 27 ans
    Et on me souhaite un joyeux anniversaire</pre>
</div>

<p>Puis exécutez la commande suivante pour lancer Behat :</p>

<div class="code code bash">
<pre class="codebash">./bin/behat</pre>
</div>

<div class="figure center" id="figure-4-2">
    <img src="images/dev-behat-exo-date-undefined.jpg" alt="Les étapes de la fonctionnalité ne sont pas encore traduites : elles sont jaunes" />

    <p class="caption"><strong>Figure 4.2</strong> Les étapes de la fonctionnalité ne sont pas encore traduites : elles sont jaunes</p>
</div>


<p>Comme vous pouvez le voir, le résultat de cette commande est jaune. Cela veut tout simplement dire 
que les phrases utilisées pour exprimer le besoin n'ont pas encore de signification pour Behat. Il va falloir 
les traduire.</p>

<h2 id="traduire-une-fonctionnalite-en-code-source">4.2 Traduire une Fonctionnalité en code source</h2>

<p>Par chance, Behat est suffisammet bien fait pour vous fournir une base de travail pour traduire vos fonctionnalités. Il suffit 
de copier-coller dans le fichier <code>features/bootstrap/FeatureContext.php</code> le code PHP qui a été généré par la commande :</p>

<div class="code code bash">
<pre class="codebash">./bin/behat</pre>
</div>

<p>Pourquoi copier ce code dans ce fichier ? Tout simplement parce que les fichiers <code>features/bootstrap/*Context.php</code> vont servir 
de passerelle entre le besoin exprimé (sous forme de phrases) et votre application.</p>

<p>Il vous appartient de modifier ces fichiers pour faire la traduction du besoin fonctionnel. C'est un travail 
qui semble long, mais en réalité il n'est pas beaucoup plus long que de tester vous-même à main que la demande initiale 
est respectée, mais à surtout l'avantage de rendre ce travail de recette interne totalement automatique.</p>

<p>Traduisez maintenant la fonctionnalité en code source dans le fichier <code>features/bootstrap/FeatureContext.php</code>, en adaptant 
le code PHP fourni par Behat selon votre besoin. Par exemple :</p>

<div class="code code php">
<pre class="codephp">&lt;?php
// (...)</pre>
</div>

<div class="code code">
<pre class="code">class FeatureContext extends BehatContext
{</pre>
</div>

<div class="code code">
<pre class="code">    private $birthDate;
    private $today;
    private $output;</pre>
</div>

<div class="code code">
<pre class="code">    /**
     * Initializes context.
     * Every scenario gets it's own context object.
     *
     * @param array $parameters context parameters (set them up through behat.yml)
     */
    public function __construct(array $parameters)
    {</pre>
</div>

<div class="code code">
<pre class="code">    }</pre>
</div>

<div class="code code">
<pre class="code">    /**
     * @Given /^que je suis né le (\d+)\/(\d+)\/(\d+)$/
     */
    public function queJeSuisNeLe($day, $month, $year)
    {
        $this-&gt;birthDate = new \DateTime(sprintf('%d-%d-%d', $year, $month, $day));
    }</pre>
</div>

<div class="code code">
<pre class="code">    /**
     * @Given /^que nous sommes le (\d+)\/(\d+)\/(\d+)$/
     */
    public function queNousSommesLe($day, $month, $year)
    {
        $this-&gt;today = new \DateTime(sprintf('%d-%d-%d', $year, $month, $day));
    }</pre>
</div>

<div class="code code">
<pre class="code">    /**
     * @Given /^je calcule mon âge$/
     */
    public function jeCalculeMonAge()
    {
        $this-&gt;output = shell_exec(sprintf('php src/age.php --birthdate=%s --today=%s', $this-&gt;birthDate-&gt;format('Y-m-d'), $this-&gt;today-&gt;format('Y-m-d')));
    }</pre>
</div>

<div class="code code">
<pre class="code">    /**
     * @Given /^je suis informé que j\'ai (\d+) ans$/
     */
    public function jeSuisInformeQueJAiAns($age)
    {
        if(!preg_match('!'.$age.' ans!', $this-&gt;output)) {
            throw new Exception();
        }
    }</pre>
</div>

<div class="code code">
<pre class="code">    /**
     * @Given /^je suis informé que je ne suis pas encore né$/
     */
    public function jeSuisInformeQueJeNeSuisPasEncoreNe()
    {
        if(!preg_match('!Vous n\'êtes pas encore né!', $this-&gt;output)) {
            throw new Exception();
        }
    }</pre>
</div>

<div class="code code">
<pre class="code">    /**
     * @Given /^on me souhaite un joyeux anniversaire$/
     */
    public function onMeSouhaiteUnJoyeuxAnniversaire()
    {
        if(!preg_match('!Joyeux anniversaire!', $this-&gt;output)) {
            throw new Exception();
        }
    }
}</pre>
</div>

<p>Notez ces différents aspects :</p>

<ul>
<li>chaque phrase est convertie en une méthode PHP</li>
<li>le lien entre les phrases et les méthodes PHP est effectué par un expression régulière (par exemple : <code>/^on me souhaite un joyeux anniversaire$/</code>)</li>
<li>vous devez traduire chaque étape. Behat comprendra qu'une étape n'est pas valide si vous levez une exception, comme c'est le cas dans la méthode <code>onMeSouhaiteUnJoyeuxAnniversaire()</code></li>
<li>il est possible de recevoir certaines informations (nombres, exemples...) sous forme de paramètres de méthodes.</li>
</ul>

<p>Maintenant, il vous suffit de relancer Behat pour vérifier automatiquement que votre application a bien 
le comportement attendu :</p>

<div class="code code bash">
<pre class="codebash">./bin/behat</pre>
</div>

<div class="figure center" id="figure-4-3">
    <img src="images/dev-behat-exo-date-fail.jpg" alt="Les fonctionnalités échouent : elles sont rouges" />

    <p class="caption"><strong>Figure 4.3</strong> Les fonctionnalités échouent : elles sont rouges</p>
</div>


<p>Il vous suffit finalement de développer votre application PHP, conforme aux attentes fonctionnelles, puis de relancer 
Behat pour vous assurer que vous avez bien traité la demande initiale.</p>

<div class="figure center" id="figure-4-4">
    <img src="images/dev-qr-exo1-step1.png" alt="Vous trouverez un exemple d'application conforme à ce besoin fonctionnel sur http://goo.gl/4usXU" />

    <p class="caption"><strong>Figure 4.4</strong> Vous trouverez un exemple d'application conforme à ce besoin fonctionnel sur http://goo.gl/4usXU</p>
</div>


<h2 id="exploitez-les-jeux-dexemples">4.3 Exploitez les jeux d'exemples</h2>

<div class="figure center" id="figure-4-5">
    <img src="images/dev-qr-exo1-step2.png" alt="Les sources de cet exercice sont disponibles sur http://goo.gl/fYZHv" />

    <p class="caption"><strong>Figure 4.5</strong> Les sources de cet exercice sont disponibles sur http://goo.gl/fYZHv</p>
</div>


<p>Vous l'avez vu, votre fonctionnel peut vous fournir des exemples, grâce à la syntaxe Gherkin.</p>

<p>On pourrait par exemple modifier notre fonctionnalité de la façon suivante :</p>

<div class="code code gherkin">
<pre class="codegherkin"># language: fr
Fonctionnalité: Calculer l'âge d'une personne
    En tant qu'utilisateur de l'application
    Je veux connaître le nombre d'années écoulées entre deux dates
    De telle sorte que je puisse connaître mon age</pre>
</div>

<div class="code code">
<pre class="code">    Plan du Scénario: Calculer l'âge d'une personne
      Etant donné que je suis né le &quot;&lt;dateNaissance&gt;&quot;
      Et que nous sommes le &quot;&lt;dateDuJour&gt;&quot;
      Quand je calcule mon âge
      Alors on me répond &quot;&lt;reponseAttendu&gt;&quot;</pre>
</div>

<div class="code code">
<pre class="code">      Exemples:
        | dateNaissance | dateDuJour | reponseAttendu                           |
        | 06/07/1986    | 20/09/2013 | Vous avez 27 ans                         |
        | 06/07/1985    | 20/09/2013 | Vous avez 28 ans                         |
        | 26/11/2020    | 20/09/2013 | Vous n'êtes pas encore né                |
        | 06/07/1986    | 06/07/2013 | Vous avez 27 ans. Joyeux anniversaire    |</pre>
</div>

<p>Vous voici avec une fonctionnalité simple, claire et complète.</p>

<p>Travailler avec des exemples ne change strictement rien pour vous. En réalité, Behat 
va travailler avec chaque jeu d'exemple, un à un, et va vous envoyer chaque information 
sous forme de paramètre de méthode, sans que cela n'ait le moindre impact sur votre code.</p>

<p>Voici une traduction possible de cette fonctionnalité :</p>

<div class="code code php">
<pre class="codephp">&lt;?php
// file features/bootstrap/FeatureContext.php
// (...)</pre>
</div>

<div class="code code">
<pre class="code">class FeatureContext extends BehatContext
{</pre>
</div>

<div class="code code">
<pre class="code">    private $birthDate;
    private $today;
    private $output;</pre>
</div>

<div class="code code">
<pre class="code">    /**
     * @Given /^que je suis né le &quot;([^&quot;]*)&quot;$/
     */
    public function queJeSuisNeLe($date)
    {
        $this-&gt;birthDate = DateTime::createFromFormat('d/m/Y', $date);
    }</pre>
</div>

<div class="code code">
<pre class="code">    /**
     * @Given /^que nous sommes le &quot;([^&quot;]*)&quot;$/
     */
    public function queNousSommesLe($date)
    {
        $this-&gt;today = DateTime::createFromFormat('d/m/Y', $date);
    }</pre>
</div>

<div class="code code">
<pre class="code">    /**
     * @Given /^je calcule mon âge$/
     */
    public function jeCalculeMonAge()
    {
        $this-&gt;output = shell_exec(sprintf('php src/age.php --birthdate=%s --today=%s', $this-&gt;birthDate-&gt;format('Y-m-d'), $this-&gt;today-&gt;format('Y-m-d')));
    }</pre>
</div>

<div class="code code">
<pre class="code">    /**
     * @Given /^on me répond &quot;([^&quot;]*)&quot;$/
     */
    public function onMeRepond($response)
    {
        if (false === strpos($this-&gt;output, $response)) {
            throw new Exception;
        }
    }
}</pre>
</div>

<p>Votre fonctionnel peut désormais ajouter autant d'exemples qui le souhaite, votre travail de traduction ne changera plus.</p>

<blockquote>
  <p>Utiliser des exemples est très simple avec Behat.</p>
</blockquote>

<h2 id="testez-dans-un-vrai-navigateur">4.4 Testez dans un vrai navigateur</h2>

<h2 id="organisez-vos-contextes-de-tests">4.5 Organisez vos Contextes de tests</h2>

<h2 id="reutilisez-vos-precedents-tests">Réutilisez vos précédents tests</h2>

    </div>

    <div class="span3">
        <div class="item local_toc">
            <h3>Table des matières</h3>

            <ul class="unstyled">
                                                <li class="level-1">
                        <span></span>
                        <a href="#chapitre-4">Automatisez votre recette</a>
                    </li>
                                    <li class="level-2">
                        <span>4.1</span>
                        <a href="#installez-et-utilisez-behat-en-php">Installez et utilisez Behat en PHP</a>
                    </li>
                                    <li class="level-2">
                        <span>4.2</span>
                        <a href="#traduire-une-fonctionnalite-en-code-source">Traduire une Fonctionnalité en code source</a>
                    </li>
                                    <li class="level-2">
                        <span>4.3</span>
                        <a href="#exploitez-les-jeux-dexemples">Exploitez les jeux d'exemples</a>
                    </li>
                                    <li class="level-2">
                        <span>4.4</span>
                        <a href="#testez-dans-un-vrai-navigateur">Testez dans un vrai navigateur</a>
                    </li>
                                    <li class="level-2">
                        <span>4.5</span>
                        <a href="#organisez-vos-contextes-de-tests">Organisez vos Contextes de tests</a>
                    </li>
                                    <li class="level-2">
                        <span>4.6</span>
                        <a href="#reutilisez-vos-precedents-tests">Réutilisez vos précédents tests</a>
                    </li>
                                        </ul>
        </div>
    </div>
</div>
</div>
</body>
</html>